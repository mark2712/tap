import { makeAutoObservable, runInAction, autorun, reaction, toJS } from 'mobx';
import TAP from '@/TAPconfig';
import messLogStore from '@/store/MessLogStore';
import telegramStore from '@/store/TelegramStore';
import coinsStore from '@/store/CoinsStore';
import energonStore from '@/store/EnergonStore';


/*
Отвечает за данные о пользователе, способе авторизации (на данный момент только телеграмм) и отправке пакотов с тапами.
Изначально класс отвечал так же за работу с тапами, поэтому часть логики обработки тапов осталась тут
*/
class MainStore {
    userData = {};
    authData = {};
    telegramStore = telegramStore;
    
    fetchTimer;
    lastFetchDate = Date.now();
    isSubmitting = false; //предотвращает отправку данных на сервер если по какой то причине предыдущие данные всё ещё отправляются

    majorСoefficient = 10000n;

    constructor() {
        makeAutoObservable(this, { authData: false });
    }


    get tapPrice(){
        return parseInt(coinsStore.tapPrice/this.majorСoefficient);
    }

    get tapPriceFinally(){
        return parseInt(coinsStore.tapPriceFinally/this.majorСoefficient);
    }

    get miningPerHour(){
        return coinsStore.mining_per_second*3600n/this.majorСoefficient;
    }

    get coins(){
        return parseInt(coinsStore.coins/this.majorСoefficient);
    }


    //загружаем данные о пользователе как только загружены данные с телеграм
    async firstUserDataLoad(){
        if(!this.userData.data){
            await this.incCoins(this.authData, {}, 0);
        }
        if(!this.userData.data){
            messLogStore.setStatus('err', '', 'Ошибка загрузки. Обновите страницу', '');
        }
        messLogStore.setFirstLoad();
    }

    //установака нового таймера
    setFetchTimer(timer){
        runInAction(() => {
            if(this.fetchTimer){
                clearInterval(this.fetchTimer);
            }
            this.fetchTimer = timer;
        });
    }

    set user(userData){
        if(userData){
            if(userData.data || userData.id){
                if(userData.id){
                    userData = {data:userData};
                }
                if(userData.data.batteries){
                    energonStore.batteries = userData.data.batteries;
                }
                this.userData = userData;
                coinsStore.clacNowCoins(userData);
            }
        }
    }

    get user(){
        return this.userData?.data || {};
    }


    //единственная и неповторимая функция отправки тапов на сервер
    async incCoins(data, tapsPacket, totalTaps) {
        this.isSubmitting = true;
        let apiUrl = TAP.apiUrl + 'inc_coins/';
        let userData = await this.fetchData({ data, taps:totalTaps }, apiUrl);

        runInAction(() => {
            if(userData && userData.success === true){
                coinsStore.confirmPacket(tapsPacket); // Подтверждаем пакет, если отправка успешна
                this.user = userData;
                energonStore.batteries = userData.batteries;
            }else{
                coinsStore.revertPacket(tapsPacket); // Восстанавливаем тапы в случае ошибки
            }
            mainStore.lastFetchDate = Date.now()+240000;
            this.isSubmitting = false;
        });
    }

    //отправка чего угодно на сервер
    async fetchData(data, apiUrl) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            let result = await response.text();
            try {
                let res = JSON.parse(result);
                messLogStore.setStatus('ok', '', '', apiUrl);
                return res;
            } catch (error) {
                messLogStore.setStatus('err', error, 'Ошибка в данных с сервера', apiUrl);
            }
        } catch (error) {
            messLogStore.setStatus('err', error, 'Ошибка сервера. Проверьте соединение с интернетом.', apiUrl);
        }
    }
}


const mainStore = new MainStore();

//загрузить данные с телеграм
if(typeof window !== 'undefined' ){
    mainStore.telegramStore.setTelegramData(mainStore);
}

//каждые Х секунд будет отправлен пакет с тапами (если есть неотправленные тапы и нет незавершенных соединений)
async function fetchData(){
    let packet = coinsStore.formPacket(); // Формируем пакет
    let totalTaps = Object.values(packet).reduce((sum, tapData) => sum + tapData.taps, 0); // Считаем количество тапов
    //(если есть неотправленные тапы или прошло 240 сек) и предыдущая отправка завершена
    if ((Object.keys(packet).length > 0 || mainStore.lastFetchDate-Date.now() < 0) && !mainStore.isSubmitting) {
        await mainStore.incCoins(mainStore.authData, packet, totalTaps); // Отправляем пакет на сервер
    }
}
mainStore.setFetchTimer(setInterval(fetchData, 5000));

export default mainStore;



/*--:--:-------------------------------:::---------:------------------:-----------------------------------------
------:::-------------------------::------------------------------------=-:=-:----------------------------------
------------------------------------------:-------------------------:==-:=+*#+----------------------------------
--:----------------------------------------------------------------==--+++++#*+---------------------------------
------------------------------------------------------------------=--+*+++++**+=--------------------------------
--:-----------------------------------------------------------:-=--+++++++++*#++--------------------------------
:-------------------------------------------------------------=--+*+++++++******--------------------------------
-------------------------------------------------------------=-+*++++++****++++--=------------------------------
-----------------------------------------------------------=-=*++++++****+++++=..:-+----------------------------
--------------------------------------------------------:-=-+++++++***+*****++:.:-+***+-------------------------
--------------------------------------------------------=-=*+++++***++#****#*::=*****+**=-----------------------
-------------------------------------------------------=-++++++***+++*#+*******+******+**+----------------------
-----------------------------------------------------===*+++++**+++#%@@%#***++++***++*+++*+---------------------
----------------------------------------------------+-+*++++***+*#@@@@@#:++++*++++++++++++*---------------------
---------------------------------------------------+-+*+++*****%@@@@##@%:+++++++***++*===+*---------------------
--------------------------------------------------+-++++*##*##@@@%##@@@*.+-.....::-==::=*::+--------------------
--------------------------------------------------=+****##*#@@@%#%@@@@*.-=-:::.:::::::-=:..==-------------------
--------------------------------------------------------=%@@@##%@@@@%=:-:.:::::-=====::::::*==------------------
--------------------------------------------------:----:=@@@#%@@@@%+-::.=+==::-====-::::-+*+===--===------------
--------------------------------------------------------::*@@@@@#=:....++:...:--::::::::#@@@@@@#+-::-====-------
-------------------------------------:-------------------:#@@@*-.....:::....:-%+.:::::.=@@@@@@@@@@*-::::--==----
--------------------------------------------------------:-%@#+:.-+=:::::.:.:+@@*.::::::%@@@@@@@@@@@%::::::::-==-
=======--==---------------------------------------------:-#=::-+==::==:.:-=+#@@*.:::::*#@@%##**+++==--===+++++=+
***************++*+*++++++++++++++++++++======+=++++++==+======*-:::----==+#@@%-.:::-#*=--=+++++++=======-------
**********************************************************+++++*#+=:.:......-=---.-*#++*#%##%%#*++++++++++*+++++
=+**+=**++*+=**+=+**+=+**++***************************************#+===========++#%#%%%#%%%#********************
**+++*+++*++*++***+++**+++********************************************%%%#*#**#%%%%%%%%%%%%%********************
****++++*+++++++++++++++++****************************************###%###*#**%#%%%%%%%%%%%%%%*****************++
*****************************************************************#**%##*#**#####*#%%%%%%%%%#%*******************
****************************************************************#%#%%#*#**#%#%#**#%%%%%%%%%%%#******************
**************************************************************#%#%#%#*#***%#%%%#%%%%%%%%%%%#%#******************
+===****===++++=+******************************************#%%##%###*##*#%##%%##%%%#%%%%%%%#%#******************
****++++****++********************************************##%#*%###*#*#*###%###%%%%%%%%%%%%#%#******************
*****************************+***************************%#*%*%###*****#%%%#**#%%#%%%%%%%%%#%#******************
******************+*******++=+=+*******+=-********===:.:.:*##%##%**#***%####*#%#%%#%#%%%%%%%%#******************
******************+++===++*****==++++==+*+=+*****#+==.-:..=@%##%******#%####%###%###%#%%%%%%%#+*****************
+++++++*++*************************+*******+=+====+*::=.:+#%##%***#+**%####%%###=*##%#%%%%%#%*******************
----------====+++++*******************************#=:-::##%####*******%###==::::.:##%#%%%%%%%#******************
============--------====+*************************#=-:-##%###%***#***#####%#:.:==-#%%%#%%%%%%#**==+******=+*****
+++****+++*++++++++=====-----==++*******************=+##%##%%#*******%#####:.:==+%%##%#%%%%#%*==**=======**===++
*********************+++++++==-----=++++***************%##%#%***#****%###%-:-:-+%#%##%#%%%%#%%********#*********
*****************************++==-----==++++++++******#%#####***#****%##%+-*+*%%%#%%#%%%%%%%%%*****+=-+*******==
*******************************++===-----==+=++++++++*%##*-=********#####%%%%%#%%#%%#%%%%%%%%#+++++***==+**+==*+
**##*****************************++++++====---====+++#--:..+***#*****:+###%%%%%%%%%%##%%%%%%%%***********++*****
******#***************************+*****+++++==----=+#*+=::#***#*****::=##%%%#%%%%#%##%%%%%#%#******************
**************++++++***************************+++++#**********#*****:.::=*##%%%%%##-=*#%##+=#+*++++************
**********+++++++==++********************************##**************-::.::-=*######+-----:.-+==========++++++++
*****++++++=======+++**********************************###**************+=--:::::::::=::----+=-------------=----
+++++++++===--===+**************#*#***********************%####***********************.-==-:-*==+===+++*++***+**
++===+====---=++***************%%#*##*##******************#%#**####%##***************=:=****=-#*****************
========----==+**####***************#********************###*******#%**#####**#######=::-=+*+:=#****************
------------==++++**************#***#***************%%##%#*******##%#**********%%#####%#*++==--*****************
-------------===+++***********%#####***#%#*****##***@@@@%#*****##%#************%#**#***#%****##*************#***
---------------==+++++*********#####**##%*****#*****#%%%@@%%##%%#%*************#%##****##%***************#*#**##
-----------------====++*********************##*********************************#%#%#**##%@@%#*******#%#**#***#%#
+++---------------==+++*********#%#******##*************************************##%#%%%@@@%%%###********########
+*%+-------------=+++***********************************************%=*%*=%******************#******###*#**#####
++%*+++==+++=-=+*###############**##########****#######***#######*##@#---#@#**#####################%%#########**
#%@*. :@#..-%++%:    ...#@.    =%%-..:@=..:@***%=.   .=%#%=.   .-%@= .=@+..+##%.     .-@%.    .*.      .%:. :@**
@@@*  .@:  :%**%+=.  .==%#     .@@:  .@.  -%**%=   #.  -@+   #.  -@=  -%.  =%#%   :   :@%   :==#==   .==@:  :@**
@@%*  .=   :%****@:  :@*%+  :.  #@:  .%.  -%**%-   @:  :@=  .@:  :@-  --   =%%#   +:  :@%   -%##*%.  -%*%-  -@**
%@#*       :%****%:  :@*%:  =-  +@:      =%#**%-   @@@@@@-  .@:  :@-       =%%+   #.  :@%     .%*%.  -%*%=  =%**
@%#*   .-  :%****%:  :%*%.  =-  :@:  .#.  =%**%-   @-..-@=  .@:  :@-   ..  =%@-  :@:  :@%   -#*#*%.  -%*%+  +%++
==**   +=  :%****%:  :%##        %:  .@.  -%**%=   %:  -@=  .@:  :@=   *:  =@+   -*.  .#%   :**##%   -%*%*--*#+=
=+#*  .@=  :%****%:  :@%=  .%#   *:  .@:  :@**##:  .  :#%%:  .  .#@-  -@:  =#          -%      =@%.  -%*%-  -%==
***#**###**##****##**###%#*#%%#*######%#**#%***###***##***##***##**#**#%#**%#  .##*#+  -@#*****####**##*##***+=-
********###************%%#**************************************************#++*%**##++*#*****************++==*/